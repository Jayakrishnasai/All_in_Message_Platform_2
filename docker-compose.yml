version: '3.8'

services:
  # Matrix Synapse Homeserver
  synapse:
    image: matrixdotorg/synapse:latest
    container_name: synapse
    restart: unless-stopped
    ports:
      - "8008:8008"
      - "8448:8448"
    volumes:
      - ./synapse/data:/data
    environment:
      - SYNAPSE_SERVER_NAME=${SYNAPSE_SERVER_NAME:-localhost}
      - SYNAPSE_REPORT_STATS=no
    networks:
      - dailyfix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/_matrix/client/versions"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Mautrix Instagram Bridge
  mautrix-instagram:
    image: dock.mau.dev/tulir/mautrix-instagram:latest
    container_name: mautrix-instagram
    restart: unless-stopped
    depends_on:
      - synapse
    volumes:
      - ./mautrix/data:/data
      - ./mautrix/config.yaml:/config.yaml:ro
    environment:
      - MATRIX_SERVER=http://synapse:8008
    networks:
      - dailyfix-network

  # AI Backend Service
  ai-backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ai-backend
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
      - ./backend/vector_store:/app/vector_store
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - dailyfix-network
    depends_on:
      - synapse

  # NGINX Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - synapse
      - ai-backend
    networks:
      - dailyfix-network

networks:
  dailyfix-network:
    driver: bridge

volumes:
  synapse-data:
  mautrix-data:
  vector-store:
